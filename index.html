<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metaplanet Valuation Model (MVM) v4.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button { padding: 0.75rem 1.25rem; border-bottom: 3px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; white-space: nowrap; }
        .tab-button.active { color: #60a5fa; border-color: #60a5fa; }
        .tab-button:not(.active):hover { color: #93c5fd; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-card { border: 1px solid; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; margin-top: -7px; cursor: pointer; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 350px; }
        html.dark body { background-color: #111827; color: #d1d5db; }
        html.dark .section-card { background-color: #1f2937; border-color: #374151; }
        html.dark .highlight-value { color: #60a5fa; }
        html.dark .subtle-text { color: #9ca3af; }
        html.dark .header-text { color: #f9fafb; }
        html.dark .nav-border { border-color: #374151; }
        html.dark input[type=range] { background-color: #374151; }
        html.dark input[type=range]::-webkit-slider-thumb { background: #60a5fa; }
        html.dark .prose { color: #d1d5db; }
        html.dark .prose h2, html.dark .prose h3 { color: #f9fafb; }
        html.dark .prose strong { color: #93c5fd; }
        html.dark .prose code { color: #a5b4fc; background-color: #374151; padding: 0.1rem 0.3rem; border-radius: 0.25rem;}
        .dot { transform: translateX(0); transition: transform 0.2s ease-in-out; }
        input:checked + .toggle-bg .dot { transform: translateX(100%); }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <div class="text-left"><h1 class="text-3xl md:text-4xl font-extrabold header-text">MVM v4.3</h1><p class="mt-1 text-lg subtle-text">Metaplanet Valuation Suite</p></div>
                <div class="flex items-center"><span class="text-sm font-medium subtle-text mr-3">Dark Mode</span><label for="dark-toggle" class="cursor-pointer"><div class="relative"><input type="checkbox" id="dark-toggle" class="sr-only" checked><div class="block bg-gray-600 w-14 h-8 rounded-full toggle-bg"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full"></div></div></label></div>
            </div>
        </header>

        <div class="border-b nav-border mb-8 overflow-x-auto">
            <nav class="-mb-px flex justify-center space-x-2 md:space-x-8" aria-label="Tabs">
                <button id="btn-snapshot" class="tab-button active">Snapshot</button>
                <button id="btn-dashboard" class="tab-button">Dashboard</button>
                <button id="btn-backtest" class="tab-button">Backtesting</button>
                <button id="btn-inputs" class="tab-button">Inputs Guide</button>
                <button id="btn-methodology" class="tab-button">Methodology</button>
            </nav>
        </div>

        <div id="tab-content-snapshot" class="tab-content active">
            <section class="section-card">
                <h2 class="text-2xl font-bold text-center header-text">Current Valuation Snapshot</h2>
                <p class="text-center subtle-text mt-1">As of June 17, 2025</p>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="text-center p-6 bg-gray-800/20 rounded-lg"><p class="text-lg subtle-text">Current Market Price</p><p id="snapshot-currentMarketPrice" class="text-6xl font-extrabold header-text mt-2"></p></div>
                    <div class="text-center p-6 bg-gray-800/20 rounded-lg"><p class="text-lg subtle-text">MVM-Implied Fair Value</p><p id="snapshot-mvmFairValue" class="text-6xl font-extrabold highlight-value mt-2"></p></div>
                </div>
            </section>
        </div>

        <div id="tab-content-dashboard" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="section-card"><h2 class="text-xl font-bold border-b border-gray-700 pb-2 mb-4 header-text">Point-in-Time Projection</h2><p class="text-sm subtle-text mb-4">A snapshot based on the future state defined by the input sliders.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center"><div class="bg-gray-800/50 p-4 rounded-lg"><p class="text-md subtle-text">Base Projected Price</p><p id="dash-outputBasePrice" class="text-4xl font-extrabold header-text"></p></div><div><p class="text-md subtle-text">Final Price (with Overshoot)</p><p id="dash-outputFinalPrice" class="text-4xl font-extrabold highlight-value"></p></div></div></div>
                    <div class="section-card"><h2 class="text-xl font-bold border-b border-gray-700 pb-2 mb-4 header-text">Monte Carlo Simulation</h2><p class="text-sm subtle-text mb-4">A 1-year probabilistic forecast based on your assumptions for BTC drift, volatility, and mNAV factors.</p><div class="text-center mb-6"><button id="runMonteCarloBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Run 1,000 Simulations</button></div><div id="mc-results" class="mt-4 grid grid-cols-3 gap-4 text-center hidden"><div class="bg-gray-800 p-3 rounded-lg"><p class="text-xs font-semibold text-red-400">Bear Case (25th %)</p><p id="mc-p25" class="text-xl font-bold header-text"></p></div><div class="bg-gray-800 p-3 rounded-lg"><p class="text-xs font-semibold text-yellow-400">Base Case (Median)</p><p id="mc-p50" class="text-xl font-bold header-text"></p></div><div class="bg-gray-800 p-3 rounded-lg"><p class="text-xs font-semibold text-green-400">Bull Case (75th %)</p><p id="mc-p75" class="text-xl font-bold header-text"></p></div></div><p id="mc-range" class="text-center text-xs subtle-text mt-2 hidden"></p></div>
                    <div class="section-card"><h2 class="text-xl font-bold border-b border-gray-700 pb-2 mb-4 header-text">Sample BTC Price Paths (1-Year Simulation)</h2><div class="chart-container"><canvas id="mcPathsChart"></canvas></div></div>
                </div>
                <div class="section-card space-y-4"><h2 class="text-xl font-bold header-text">Model Inputs</h2>
                    <div><label class="font-medium text-sm subtle-text">Future BTC Target Price</label><span id="dash-btcTargetDisplay" class="float-right font-mono text-sm subtle-text"></span><input type="range" id="dash-btcTargetSlider" min="100000" max="500000" value="225000" step="1000" class="w-full h-2 rounded-lg appearance-none"></div>
                    <div><label class="font-medium text-sm subtle-text">Future BTC Holdings</label><span id="dash-btcHoldingsDisplay" class="float-right font-mono text-sm subtle-text"></span><input type="range" id="dash-btcHoldingsSlider" min="10000" max="250000" value="180000" step="1000" class="w-full h-2 rounded-lg appearance-none"></div>
                    <div><label class="font-medium text-sm subtle-text">Acquisition mNAV</label><span id="dash-acquisitionMnavDisplay" class="float-right font-mono text-sm subtle-text"></span><input type="range" id="dash-acquisitionMnavSlider" min="3" max="15" value="8" step="0.5" class="w-full h-2 rounded-lg appearance-none"></div>
                    <div><label class="font-medium text-sm subtle-text">BTC Annual Volatility</label><span id="dash-volatilityDisplay" class="float-right font-mono text-sm subtle-text"></span><input type="range" id="dash-volatilitySlider" min="0.3" max="1.2" value="0.7" step="0.05" class="w-full h-2 rounded-lg appearance-none"></div>
                    <div><label class="font-medium text-sm subtle-text">Speculative Overshoot</label><span id="dash-overshootDisplay" class="float-right font-mono text-sm subtle-text"></span><input type="range" id="dash-overshootSlider" min="1" max="2" value="1.2" step="0.05" class="w-full h-2 rounded-lg appearance-none"></div>
                    <div id="dash-factorInputsContainer" class="space-y-3 pt-2"></div>
                </div>
            </div>
        </div>

        <div id="tab-content-backtest" class="tab-content">
            <div class="space-y-8">
                <div class="section-card"><h2 class="text-2xl font-bold text-center header-text">Historical Premium (mNAV) Analysis</h2><div class="chart-container mt-6"><canvas id="premiumChart"></canvas></div></div>
                <div class="section-card"><h2 class="text-2xl font-bold text-center header-text">Model Backtest (Weekly Data)</h2><div class="mt-6 flow-root"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-700"><thead class="bg-gray-800"><tr><th class="px-3 py-3.5 text-left text-sm font-semibold header-text">Date</th><th class="px-3 py-3.5 text-left text-sm font-semibold header-text">Actual Price</th><th class="px-3 py-3.5 text-left text-sm font-semibold header-text">NAV</th><th class="px-3 py-3.5 text-left text-sm font-semibold header-text">Implied Price</th><th class="px-3 py-3.5 text-left text-sm font-semibold header-text">Error %</th></tr></thead><tbody id="backtestTableBody" class="divide-y divide-gray-700"></tbody></table></div></div></div>
            </div>
        </div>
        
        <div id="tab-content-inputs" class="tab-content"><div id="inputs-guide-container" class="section-card prose prose-invert max-w-none prose-headings:border-b prose-headings:border-gray-600 prose-headings:pb-2"></div></div>
        <div id="tab-content-methodology" class="tab-content"><div id="methodology-container" class="section-card prose prose-invert max-w-none prose-headings:border-b prose-headings:border-gray-600 prose-headings:pb-2"></div></div>
    </div>
    
    <script>
        const MVM_CONFIG = {
            LIVE_DATA: { mtplfPrice: 13.15, btcPrice: 107750, btcHeld: 10000, shares: 600710000, cash: 22000000, debt: 18000000 },
            MNAV_FACTORS: {
                basePremium: { value: 2.0 }, beta: { label: "Leveraged BTC Beta", weight: 0.30, min: -1, max: 3, value: 1.5, desc: "Measures MTPLF's price volatility relative to Bitcoin. A higher beta acts like a call option, attracting speculation and increasing the premium." },
                flows: { label: "Institutional Demand", weight: 0.25, min: -2, max: 2, value: 0.8, desc: "Normalized net flows into spot Bitcoin ETFs. Positive flows signal institutional conviction, increasing market legitimacy and the premium." },
                sentiment: { label: "Market Sentiment", weight: 0.15, min: -2, max: 2, value: 0.5, desc: "A normalized score from the Crypto Fear & Greed Index. High 'greed' indicates strong retail interest, which can drive the premium higher." },
                macro: { label: "Macro-Risk Environment", weight: 0.20, min: -2, max: 2, value: -0.2, desc: "A risk signal based on BTC's correlation to the NASDAQ and 10-Year Treasury yields. A 'risk-off' environment (high correlation, high yields) is a headwind for the premium." },
                native: { label: "Crypto-Native Value", weight: 0.10, min: -2, max: 2, value: 0.1, desc: "Measures capital rotation within crypto (e.g., Altcoin Dominance). A high value suggests capital is moving to more speculative assets, which can be a slight negative for a BTC proxy." },
            },
            Z_SCORE_SCALE: 5,
            SIGMOID_SQUASH_FACTOR: 8.0, 
            HISTORICAL_DATA: [
                { date: '2025-04-20', btcPrice: 128000, actualPrice: 16.50, btcHeld: 10000, shares: 600000000, factors: { beta: 2.0, flows: 1.2, sentiment: 1.0, macro: -0.1, native: 0.1 } },
                { date: '2025-04-27', btcPrice: 135000, actualPrice: 18.00, btcHeld: 10000, shares: 600000000, factors: { beta: 2.2, flows: 1.5, sentiment: 1.2, macro: 0.0, native: 0.3 } },
                { date: '2025-05-04', btcPrice: 125000, actualPrice: 14.20, btcHeld: 10000, shares: 600000000, factors: { beta: 1.8, flows: 0.8, sentiment: 0.6, macro: -0.2, native: 0.0 } },
                { date: '2025-05-11', btcPrice: 118000, actualPrice: 12.50, btcHeld: 10000, shares: 600000000, factors: { beta: 1.6, flows: 0.2, sentiment: 0.2, macro: -0.4, native: -0.2 } },
                { date: '2025-05-18', btcPrice: 110000, actualPrice: 11.50, btcHeld: 10000, shares: 600000000, factors: { beta: 1.3, flows: -0.2, sentiment: -0.5, macro: -0.5, native: -0.4 } },
                { date: '2025-05-25', btcPrice: 105000, actualPrice: 10.80, btcHeld: 10000, shares: 600000000, factors: { beta: 1.2, flows: -0.5, sentiment: -0.8, macro: -0.6, native: -0.5 } },
                { date: '2025-06-01', btcPrice: 112000, actualPrice: 12.00, btcHeld: 10000, shares: 600000000, factors: { beta: 1.4, flows: 0.1, sentiment: 0.0, macro: -0.3, native: -0.1 } },
                { date: '2025-06-08', btcPrice: 115000, actualPrice: 13.80, btcHeld: 10000, shares: 600000000, factors: { beta: 1.6, flows: 0.6, sentiment: 0.4, macro: -0.1, native: 0.1 } },
                { date: '2025-06-15', btcPrice: 107750, actualPrice: 13.15, btcHeld: 10000, shares: 600710000, factors: { beta: 1.5, flows: 0.8, sentiment: 0.5, macro: -0.2, native: 0.1 } },
            ]
        };

        const DOM = { dash: { sliders: {}, factorSliders: {} } };
        let mcPathsChart = null;

        const formatCurrency = (val, minDigits = 2) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: minDigits }).format(val);
        
        function calculateEnhancedNAV(p, h, s, c, d) { return s > 0 ? (p * h + c - d) / s : 0; }
        
        function sigmoid(z) { return 1 / (1 + Math.exp(-z)); }

        function getMnavFromFactors(factorValues) {
            let linearSum = 0;
            for (const key in factorValues) {
                if (MVM_CONFIG.MNAV_FACTORS[key]?.weight) {
                    linearSum += factorValues[key] * MVM_CONFIG.MNAV_FACTORS[key].weight;
                }
            }
            const squashedFactorImpact = (sigmoid(linearSum) - 0.5) * MVM_CONFIG.SIGMOID_SQUASH_FACTOR;
            return MVM_CONFIG.MNAV_FACTORS.basePremium.value + squashedFactorImpact;
        }

        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-content-${tabId}`)?.classList.add('active');
            element?.classList.add('active');
        }
        
        function getSliderValues() {
            const values = {};
            for (const key in DOM.dash.sliders) if (DOM.dash.sliders[key]) values[key] = parseFloat(DOM.dash.sliders[key].value);
            values.factorValues = {};
            for (const key in DOM.dash.factorSliders) if (DOM.dash.factorSliders[key]) values.factorValues[key] = parseFloat(DOM.dash.factorSliders[key].value);
            return values;
        }

        function runPointInTimeProjection() {
            const sliderVals = getSliderValues();
            const { btcTarget, btcHoldings, overshoot, factorValues } = sliderVals;
            const mnav = getMnavFromFactors(factorValues);
            const nav = calculateEnhancedNAV(btcTarget, btcHoldings, MVM_CONFIG.LIVE_DATA.shares, MVM_CONFIG.LIVE_DATA.cash, MVM_CONFIG.LIVE_DATA.debt);
            const basePrice = nav * mnav;
            const finalPrice = basePrice * overshoot;
            updateDashboardUI({ nav, mnav, basePrice, finalPrice, sliderVals });
        }

        function updateDashboardUI(values) {
            const { nav, mnav, basePrice, finalPrice, sliderVals } = values;
            document.getElementById('dash-btcTargetDisplay').textContent = formatCurrency(sliderVals.btcTarget, 0);
            document.getElementById('dash-btcHoldingsDisplay').textContent = new Intl.NumberFormat().format(sliderVals.btcHoldings);
            document.getElementById('dash-volatilityDisplay').textContent = (sliderVals.volatility * 100).toFixed(0) + '%';
            document.getElementById('dash-acquisitionMnavDisplay').textContent = `${sliderVals.acquisitionMnav.toFixed(1)}x`;
            document.getElementById('dash-overshootDisplay').textContent = `${sliderVals.overshoot.toFixed(2)}x`;
            document.getElementById('dash-outputBasePrice').textContent = formatCurrency(basePrice);
            document.getElementById('dash-outputFinalPrice').textContent = formatCurrency(finalPrice);
            for (const key in DOM.dash.factorSliders) {
                document.getElementById(`dash-display-${key}`).textContent = parseFloat(DOM.dash.factorSliders[key].value).toFixed(1);
            }
        }

        function runMonteCarlo() {
            const { btcTarget, volatility, btcHoldings, factorValues } = getSliderValues();
            const drift = Math.log(btcTarget / MVM_CONFIG.LIVE_DATA.btcPrice);
            const mnav = getMnavFromFactors(factorValues);
            const finalPrices = [], samplePaths = [];
            const numSims = 1000, timeSteps = 252, dt = 1 / timeSteps;
            const startDate = new Date();

            for(let i = 0; i < numSims; i++) {
                let simBtcPrice = MVM_CONFIG.LIVE_DATA.btcPrice;
                const path = [simBtcPrice];
                for(let t = 0; t < timeSteps; t++) {
                     const Z = Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random());
                     simBtcPrice *= Math.exp((drift - 0.5 * volatility**2) * dt + volatility * Math.sqrt(dt) * Z);
                     path.push(simBtcPrice);
                }
                const simNav = calculateEnhancedNAV(simBtcPrice, btcHoldings, MVM_CONFIG.LIVE_DATA.shares, MVM_CONFIG.LIVE_DATA.cash, MVM_CONFIG.LIVE_DATA.debt);
                finalPrices.push(simNav * mnav);
                if (i < 10) samplePaths.push(path);
            }
            finalPrices.sort((a,b) => a-b);
            document.getElementById('mc-p25').textContent = formatCurrency(finalPrices[Math.floor(numSims * 0.25)]);
            document.getElementById('mc-p50').textContent = formatCurrency(finalPrices[Math.floor(numSims * 0.50)]);
            document.getElementById('mc-p75').textContent = formatCurrency(finalPrices[Math.floor(numSims * 0.75)]);
            document.getElementById('mc-range').textContent = `5th-95th Range: ${formatCurrency(finalPrices[Math.floor(numSims*0.05)])} – ${formatCurrency(finalPrices[Math.floor(numSims*0.95)])}`;
            document.getElementById('mc-results').classList.remove('hidden');
            document.getElementById('mc-range').classList.remove('hidden');
            visualizeSamplePaths(samplePaths, startDate, timeSteps);
        }
        
        function visualizeSamplePaths(paths, startDate, timeSteps) {
            const labels = Array.from({length: timeSteps + 1}, (_, i) => new Date(startDate.getTime() + i * (365/timeSteps) * 24 * 60 * 60 * 1000));
            const datasets = paths.map((path) => ({ data: path, borderColor: `rgba(96, 165, 250, 0.3)`, borderWidth: 1.5, pointRadius: 0, tension: 0.2 }));
            if (mcPathsChart) mcPathsChart.destroy();
            mcPathsChart = new Chart('mcPathsChart', {
                type: 'line', data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: {
                        y: { type: 'logarithmic', ticks: { callback: value => formatCurrency(value,0), color: '#9ca3af' }, grid: { color: '#374151' } },
                        x: { type: 'time', time: { unit: 'month' }, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    }
                }
            });
        }
        
        function initializeDOM() {
            const sliderIds = ['btcTarget', 'btcHoldings', 'volatility', 'acquisitionMnav', 'overshoot'];
            sliderIds.forEach(id => DOM.dash.sliders[id] = document.getElementById(`dash-${id}Slider`));
            const container = document.getElementById('dash-factorInputsContainer');
            if (container) {
                Object.keys(MVM_CONFIG.MNAV_FACTORS).forEach(key => {
                    const factor = MVM_CONFIG.MNAV_FACTORS[key];
                    if (!factor.label) return;
                    const div = document.createElement('div');
                    div.innerHTML = `<label class="font-medium text-xs subtle-text">${factor.label}</label><span id="dash-display-${key}" class="float-right font-mono text-sm subtle-text"></span><input type="range" id="dash-slider-${key}" min="${factor.min}" max="${factor.max}" value="${factor.value}" step="0.1" class="w-full h-2 rounded-lg appearance-none">`;
                    container.appendChild(div);
                    DOM.dash.factorSliders[key] = document.getElementById(`dash-slider-${key}`);
                });
            }
        }
        
        function initializeBacktestingUI() {
            const { HISTORICAL_DATA, LIVE_DATA } = MVM_CONFIG;
            const tableBody = document.getElementById('backtestTableBody');
            const premiumData = [], labels = [];
            HISTORICAL_DATA.forEach(row => {
                const nav = calculateEnhancedNAV(row.btcPrice, row.btcHeld, row.shares, LIVE_DATA.cash, LIVE_DATA.debt);
                const impliedMnav = getMnavFromFactors(row.factors);
                const impliedPrice = nav * impliedMnav;
                const error = ((impliedPrice / row.actualPrice) - 1) * 100;
                let errorColor = Math.abs(error) > 15 ? 'text-red-400' : (Math.abs(error) > 5 ? 'text-yellow-400' : 'text-green-400');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-3 py-4 text-sm subtle-text">${row.date}</td><td class="px-3 py-4 text-sm font-medium header-text">${formatCurrency(row.actualPrice)}</td><td class="px-3 py-4 text-sm subtle-text">${formatCurrency(nav)}</td><td class="px-3 py-4 text-sm highlight-value font-semibold">${formatCurrency(impliedPrice)}</td><td class="px-3 py-4 text-sm font-semibold ${errorColor}">${error.toFixed(1)}%</td>`;
                tableBody.appendChild(tr);
                premiumData.push(row.actualPrice / nav);
                labels.push(row.date);
            });
            new Chart('premiumChart', {
                type: 'line', data: { labels, datasets: [{ label: 'Realized mNAV', data: premiumData, borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.2)', fill: true, tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => v.toFixed(1) + 'x', color: '#9ca3af' }, grid: { color: '#374151' }, title: {display: true, text: 'mNAV Multiple', color: '#9ca3af'} }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } } }
            });
        }
        
        function populateMethodologyAndInputs() {
            const methodologyEl = document.getElementById('methodology-container');
            const inputsGuideEl = document.getElementById('inputs-guide-container');
            let methodologyHTML = ``;
            let inputsGuideHTML = `<h2>Dashboard Input Guide</h2><p class="subtle-text">This guide explains each interactive input on the dashboard.</p>`;
            methodologyHTML += `<h3 class="header-text">Module 1: Enhanced Net Asset Value (NAV)</h3><p>Calculates the true intrinsic value per share by accounting for all major assets and liabilities, not just Bitcoin holdings.</p><code>NAV/Share = (BTC Value + Cash - Debt) / Shares</code><hr class="my-6 border-gray-700">`;
            methodologyHTML += `<h3 class="header-text">Module 2: The mNAV Engine</h3><p>Calculates the 'fair' premium multiple using a weighted, quantitative factor model. The premium is not arbitrary; it's a function of measurable market forces.</p><code>mNAV = Base + Squashed(&Sigma;(Z-Score * Weight))</code><p class="mt-2 subtle-text">The 'Squashed' term refers to a sigmoid function that prevents the model from overreacting to extreme factor inputs, improving its stability and accuracy.</p><hr class="my-6 border-gray-700">`;
            methodologyHTML += `<h3 class="header-text">Module 3: Price Projection Engine</h3><p>Combines the NAV and mNAV engines and adds layers for dynamic corporate behavior and market momentum to forecast a final price.</p><code>Final Price = (Projected NAV * Projected mNAV) * Overshoot</code>`;
            inputsGuideHTML += `<h3 class="mt-6 header-text">Core Assumptions</h3>`;
            inputsGuideHTML += `<p><strong>Future BTC Target Price:</strong> Sets the annualized drift for the Monte Carlo simulation. A higher target implies a stronger upward trend in the random price paths.</p>`;
            inputsGuideHTML += `<p><strong>Future BTC Holdings:</strong> Your assumption for how many total Bitcoin Metaplanet will own at the end of the simulation period.</p>`;
            inputsGuideHTML += `<p><strong>BTC Annual Volatility:</strong> The expected standard deviation of Bitcoin's price. Higher volatility leads to a wider range of possible outcomes in the Monte Carlo simulation.</p>`;
            inputsGuideHTML += `<h3 class="mt-6 header-text">mNAV Factor Model Inputs (Z-Scores)</h3><p>These sliders represent the "temperature" of each factor, measured in standard deviations from its historical average (a z-score of 0 is average).</p>`;
            for (const key in MVM_CONFIG.MNAV_FACTORS){
                const factor = MVM_CONFIG.MNAV_FACTORS[key];
                if(factor.label) {
                    inputsGuideHTML += `<p><strong>${factor.label}:</strong> ${factor.desc}</p>`;
                }
            }
            methodologyEl.innerHTML = methodologyHTML;
            inputsGuideEl.innerHTML = inputsGuideHTML;
        }

        function populateSnapshot() {
            const { LIVE_DATA, MNAV_FACTORS } = MVM_CONFIG;
            const defaultFactorValues = {};
            Object.keys(MNAV_FACTORS).forEach(key => {
                if (MNAV_FACTORS[key].label) defaultFactorValues[key] = MNAV_FACTORS[key].value;
            });
            const mnav = getMnavFromFactors(defaultFactorValues);
            const nav = calculateEnhancedNAV(LIVE_DATA.btcPrice, LIVE_DATA.btcHeld, LIVE_DATA.shares, LIVE_DATA.cash, LIVE_DATA.debt);
            document.getElementById('snapshot-currentMarketPrice').textContent = formatCurrency(LIVE_DATA.mtplfPrice);
            document.getElementById('snapshot-mvmFairValue').textContent = formatCurrency(nav * mnav);
        }

        function initializeEventListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabId = button.id.split('-')[1];
                    switchTab(tabId, e.currentTarget);
                });
            });
            Object.values({...DOM.dash.sliders, ...DOM.dash.factorSliders}).forEach(slider => {
                if (slider) slider.addEventListener('input', runPointInTimeProjection);
            });
            document.getElementById('runMonteCarloBtn')?.addEventListener('click', runMonteCarlo);
            document.getElementById('dark-toggle')?.addEventListener('change', (e) => {
                document.documentElement.classList.toggle('dark', e.target.checked);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDOM();
            initializeEventListeners();
            runPointInTimeProjection();
            initializeBacktestingUI();
            populateMethodologyAndInputs();
            populateSnapshot();
        });
    </script>
</body>
</html>
